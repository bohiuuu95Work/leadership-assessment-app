<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leadership Assessment App - Version 5.2</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- Load html2canvas and jsPDF for robust PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .card { background: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); border: 1px solid #e2e8f0; }
        .chart-container { position: relative; height: 400px; width: 100%; }
        
        .score-high { background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .score-med { background-color: #fef9c3; color: #854d0e; border: 1px solid #fef08a; }
        .score-low { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }

        input[type="radio"] + label {
            transition: all 0.15s ease-in-out;
            user-select: none;
            cursor: pointer;
        }
        input[type="radio"]:checked + label {
            background-color: #4f46e5;
            color: white;
            border-color: #4338ca;
            transform: scale(1.05);
        }
        .ai-shimmer {
            background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Specific PDF Styles to ensure table fits */
        .pdf-table-compact td, .pdf-table-compact th {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            font-size: 0.85rem; 
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-6xl mx-auto">
        <header class="text-center mb-10" id="main-header">
            <h1 class="text-4xl font-extrabold text-slate-900 tracking-tight">Leadership Assessment</h1>
            <p class="text-indigo-600 font-bold uppercase tracking-widest text-sm mt-2">Student Edition - Version 5.2</p>
            <p class="text-lg text-slate-500 mt-1">Self-reflect on your behaviors from 1 (Rarely) to 4 (Very Frequently)</p>
        </header>

        <!-- Assessment Form Section -->
        <section id="form-section" class="mb-10 card overflow-hidden">
            <form id="assessmentForm">
                <div class="p-8 bg-slate-50 border-b border-slate-200">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">Student Information</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm font-semibold text-slate-600 mb-2">Full Name</label>
                            <input type="text" name="userName" required placeholder="Enter your name" 
                                class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500 outline-none transition">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-600 mb-2">Class</label>
                            <input type="text" name="userClass" required placeholder="e.g. 4 Integrity" 
                                class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500 outline-none transition">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-600 mb-2">CCA</label>
                            <input type="text" name="userCCA" required placeholder="Enter your CCA" 
                                class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500 outline-none transition">
                        </div>
                    </div>
                </div>

                <div class="p-8">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">40 Assessment Items</h2>
                    <div id="questionsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Questions injected via JS -->
                    </div>
                    
                    <div class="mt-10">
                        <button type="submit" class="w-full px-8 py-4 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition duration-150 transform hover:scale-[1.01]">
                            Generate My Report
                        </button>
                    </div>
                </div>
            </form>
        </section>

        <!-- Results Section (Visible View) -->
        <div id="results-area" class="hidden pb-20">
            
            <div id="report-view-content" class="space-y-12">
                
                <!-- PAGE 1 CONTENT -->
                <div id="pdf-page-1">
                    <!-- COMPONENT 1: Header Profile -->
                    <section id="comp-header" class="card p-8 bg-slate-900 text-white mb-8">
                        <div class="flex flex-col md:flex-row justify-between gap-6">
                            <div>
                                <p class="text-indigo-400 font-bold uppercase tracking-widest text-xs mb-1">Individual Report</p>
                                <h2 id="display-name" class="text-3xl font-bold">Student Name</h2>
                            </div>
                            <div class="grid grid-cols-2 gap-x-8 gap-y-2">
                                <div>
                                    <!-- Use a simple ID for targeting -->
                                    <p id="display-class" class="text-slate-400 font-bold text-lg"></p>
                                </div>
                                <div>
                                    <p id="display-cca" class="text-slate-400 font-bold text-lg"></p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- COMPONENT 2: AI Summary -->
                    <section id="comp-ai" class="card p-8 bg-gradient-to-br from-indigo-50 to-white border-indigo-100">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                            <div>
                                <h2 class="text-2xl font-bold text-indigo-900">Personalised Growth Summary</h2>
                                <p class="text-indigo-600 italic text-sm">A helpful perspective on your journey as a youth leader</p>
                            </div>
                            <button id="generateSummaryBtn" class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-bold shadow hover:bg-indigo-700 transition" data-html2canvas-ignore="true">
                                Generate Summary
                            </button>
                        </div>
                        <div id="aiSummaryContent" class="text-slate-700 leading-relaxed italic border-l-4 border-indigo-200 pl-6 py-2">
                            Submit the form and click the button to generate a modest reflection on your results.
                        </div>
                    </section>
                </div>
                
                <!-- PAGE 2 CONTENT -->
                <div id="pdf-page-2">
                    <!-- COMPONENT 3: LPI Section (1a + 1b) -->
                    <section id="comp-lpi" class="space-y-6">
                        <h2 class="text-3xl font-extrabold text-slate-800 border-b pb-4">The Leadership Challenge</h2>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                            <!-- 1a Chart -->
                            <div class="card p-6" id="lpi-chart-card">
                                <h3 class="text-lg font-bold text-indigo-600 mb-6 uppercase tracking-wider">1a. 5 Practices of Exemplary Leadership</h3>
                                <div class="h-[350px]">
                                    <canvas id="lpiBarChart"></canvas>
                                </div>
                            </div>
                            <!-- 1b Table -->
                            <div class="card p-6 overflow-hidden">
                                <h3 class="text-lg font-bold text-indigo-600 mb-4 uppercase tracking-wider">1b. Practice Score Breakdown</h3>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-left">
                                        <thead>
                                            <tr class="text-slate-400 text-xs border-b uppercase tracking-tighter">
                                                <th class="pb-3 font-semibold">Leadership Practice</th>
                                                <th class="pb-3 text-center font-semibold">Score (Raw)</th>
                                                <th class="pb-3 text-right font-semibold">Performance</th>
                                            </tr>
                                        </thead>
                                        <tbody id="lpi-table-body" class="divide-y"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
                
                <!-- PAGE 3 CONTENT -->
                <div id="pdf-page-3">
                    <!-- COMPONENT 4: TMLH Section (2a + 2b) -->
                    <section id="comp-tmlh" class="space-y-6">
                        <h2 class="text-3xl font-extrabold text-slate-800 border-b pb-4">TMLH Attributes</h2>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                            <!-- 2a Chart -->
                            <div class="card p-6" id="tmlh-chart-card">
                                <h3 class="text-lg font-bold text-emerald-600 mb-4 uppercase tracking-wider">2a. Attribute Distribution</h3>
                                <div class="chart-container">
                                    <canvas id="tmlhPolarChart"></canvas>
                                </div>
                            </div>
                            <!-- 2b Table -->
                            <div class="card p-6 overflow-hidden">
                                <h3 class="text-lg font-bold text-emerald-600 mb-4 uppercase tracking-wider">2b. Attribute Score Breakdown</h3>
                                <div class="overflow-x-auto">
                                    <!-- Reduced padding via class for PDF -->
                                    <table class="w-full text-left pdf-table-compact">
                                        <thead>
                                            <tr class="text-slate-400 text-xs border-b uppercase tracking-tighter">
                                                <th class="pb-3 font-semibold">Attribute</th>
                                                <th class="pb-3 text-center font-semibold">Score (Raw)</th>
                                                <th class="pb-3 text-right font-semibold">Performance</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tmlh-table-body" class="divide-y"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>

            <!-- Download PDF Button Area -->
            <div class="flex justify-center py-10" id="download-actions">
                <button id="downloadPdfBtn" class="px-10 py-4 bg-slate-800 text-white font-bold rounded-xl shadow-xl hover:bg-slate-900 transition transform hover:scale-105 border-2 border-slate-700">
                    Download Final Report (3 Pages)
                </button>
            </div>
        </div>
    </div>

    <!-- Container for PDF Staging -->
    <div id="pdf-export-staging"></div>

    <script>
        const apiKey = ""; 
        const LPI_PRACTICES = { MW: 'Model the Way', ISV: 'Inspire a Shared Vision', CP: 'Challenge the Process', EOA: 'Enable Others to Act', EH: 'Encourage the Heart' };
        const PRACTICE_KEYS_CYCLIC = ['MW', 'ISV', 'CP', 'EOA', 'EH'];
        
        // Custom colors for LPI Bar Chart
        // Order: MW (Blue), ISV (Yellow), CP (Green), EOA (Orange), EH (Red)
        const LPI_COLORS = [
            '#3b82f6', // Model the Way - Blue
            '#eab308', // Inspire a Shared Vision - Yellow
            '#10b981', // Challenge the Process - Green
            '#f97316', // Enable Others to Act - Orange
            '#ef4444'  // Encourage the Heart - Red
        ];

        // --- PRECISE TMLH MAPPING ---
        const TMLH_MAPPING = {
            'Integrity': [1, 6, 11, 21, 26, 36],
            'Purpose': [2, 7, 12, 13, 27, 32, 37, 40],
            'Initiative': [3, 8, 12, 13, 23, 28, 38],
            'Discernment': [3, 11, 21, 23, 31, 32, 36, 37, 38, 39],
            'Nurturing': [4, 5, 7, 8, 10, 15, 17, 19, 20, 21, 22, 24, 25, 29, 30, 34, 35, 40],
            'Humility': [5, 8, 9, 14, 16, 19, 29, 37, 39],
            'Resilience': [18, 31, 33]
        };

        const TMLH_COLORS = ['rgba(59, 130, 246, 0.7)', 'rgba(16, 185, 129, 0.7)', 'rgba(245, 158, 11, 0.7)', 'rgba(239, 68, 68, 0.7)', 'rgba(139, 92, 246, 0.7)', 'rgba(236, 72, 153, 0.7)', 'rgba(6, 182, 212, 0.7)'];

        const BASE_ITEMS = [
            { id: 1, text: "Sets a personal example of what he or she expects from other people." },
            { id: 2, text: "Looks ahead and communicates about what he or she believes will impact the future." },
            { id: 3, text: "Looks around for ways to develop and challenge his or her skills and abilities." },
            { id: 4, text: "Fosters cooperative rather than competitive relationships among people." },
            { id: 5, text: "Praises people for a job well done." },
            { id: 6, text: "Spends time and energy making sure people adhere to principles and standards." },
            { id: 7, text: "Describes to others in the team what they should be capable of accomplishing." },
            { id: 8, text: "Looks for ways that others can try out new ideas and methods." },
            { id: 9, text: "Actively listens to diverse points of view." },
            { id: 10, text: "Encourages others as they work on tasks during the activity." },
            { id: 11, text: "Follows through on the promises and commitments he or she makes." },
            { id: 12, text: "Uses images and stories to describe possibilities for the future." },
            { id: 13, text: "Challenges the team to try new ways of working." },
            { id: 14, text: "Helps team members find common ground and shared goals." },
            { id: 15, text: "Recognizes people for their contributions to the success of the team." },
            { id: 16, text: "Is clear about his or her leadership philosophy." },
            { id: 17, text: "Seeks out challenging opportunities that test his or her abilities." },
            { id: 18, text: "Takes initiative in experimenting with the way we can do things in the team." },
            { id: 19, text: "Asks for feedback on how his or her actions affect team performance." },
            { id: 20, text: "Supports the decisions that team members make." },
            { id: 21, text: "Makes sure that the team's actions are consistent with its stated values." },
            { id: 22, text: "Paints an exciting picture of the long-term future for the team." },
            { id: 23, text: "Looks for innovative ways to improve team results." },
            { id: 24, text: "Gets the team to work effectively with other teams/groups." },
            { id: 25, text: "Finds ways for us to celebrate accomplishments." },
            { id: 26, text: "Talks about the values and principles that guide his or her actions." },
            { id: 27, text: "Speaks with conviction about the higher purpose of what we are doing." },
            { id: 28, text: "Takes initiative in experimenting with the way we can do things in the team." },
            { id: 29, text: "Provides opportunities for others to take on leadership responsibilities." },
            { id: 30, text: "Makes sure that people in the team are creatively recognized." },
            { id: 31, text: "Successfully carries out planned events / tasks." },
            { id: 32, text: "Communicates clearly with others about assigned tasks and ideas." },
            { id: 33, text: "Presses on in the face of difficulties." },
            { id: 34, text: "Shares information and resources with teammates." },
            { id: 35, text: "Is spontaneous in thanking or praising others for their contribution." },
            { id: 36, text: "Makes morally sound decisions." },
            { id: 37, text: "Articulates and expresses the needs of the team." },
            { id: 38, text: "Generates creative solutions." },
            { id: 39, text: "Involves team members in making important decisions." },
            { id: 40, text: "Shows care and concern for teammates when they are tired or demoralized." }
        ];

        let lastResults = null;
        let lpiChartInstance = null;
        let tmlhChartInstance = null;

        // --- GEMINI API INTEGRATION ---
        async function callGemini(prompt, systemInstruction) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] }
            };

            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error('Retry limit reached');
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch (e) {
                    await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                }
            }
            throw new Error("Failed to connect to âœ¨ Reflection service.");
        }

        async function generateAISummary() {
            const btn = document.getElementById('generateSummaryBtn');
            const content = document.getElementById('aiSummaryContent');
            btn.disabled = true;
            content.innerHTML = '<div class="h-10 w-full ai-shimmer rounded mb-2"></div><div class="h-6 w-3/4 ai-shimmer rounded"></div>';
            
            const prompt = `Student Leadership Scores: LPI: ${JSON.stringify(lastResults.lpi.map(r => ({name: r.name, pct: r.pct})))}. Character: ${JSON.stringify(lastResults.tmlh.map(r => ({name: r.name, pct: r.pct})))}. Note: User is 17-18 years old. These are self-assessment scores.`;
            const sys = "You are an encouraging youth leadership mentor. Write a modest and gentle summary of these results (max 120 words). Avoid hyperbole like 'bold transformation' or 'chief initiator.' Use humble phrases like 'it seems you often find joy in...', 'this suggests you are developing a habit of...', or 'an area where you might find more opportunities to grow is...'. Acknowledge their scores as reflections of their current experiences as students. Be thoughtful, not grandiose.";
            
            try {
                const text = await callGemini(prompt, sys);
                content.innerText = text;
            } catch (e) {
                content.innerHTML = `<span class="text-red-500">${e.message}</span>`;
            } finally {
                btn.disabled = false;
            }
        }

        // --- DATA PROCESSING & UI ---
        function getTier(pct) {
            if (pct >= 80) return { label: 'STRENGTH', class: 'score-high' };
            if (pct >= 50) return { label: 'IN PROGRESS', class: 'score-med' };
            return { label: 'AREA FOR IMPROVEMENT', class: 'score-low' };
        }

        function renderQuestions() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = BASE_ITEMS.map(item => `
                <div class="p-4 border rounded-lg bg-white transition hover:border-indigo-300 shadow-sm">
                    <p class="text-xs font-bold text-indigo-500 mb-1">Item ${item.id}</p>
                    <p class="text-slate-800 font-medium mb-3">${item.text}</p>
                    <div class="flex gap-2">
                        ${[1, 2, 3, 4].map(s => `
                            <input type="radio" id="q${item.id}_s${s}" name="q${item.id}" value="${s}" class="hidden" required />
                            <label for="q${item.id}_s${s}" class="flex-1 py-2 border rounded-lg text-center font-bold text-slate-600 hover:bg-slate-50">${s}</label>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function processScores(formData) {
            // Initialize containers
            const lpi = {}; 
            Object.keys(LPI_PRACTICES).forEach(k => lpi[k] = { name: LPI_PRACTICES[k], sum: 0, count: 0 });
            
            const tmlh = {};
            // Initialize TMLH from explicit mapping
            Object.keys(TMLH_MAPPING).forEach(attrName => {
                tmlh[attrName] = { 
                    name: attrName, 
                    sum: 0, 
                    count: TMLH_MAPPING[attrName].length 
                };
            });

            // Iterate through all 40 questions to sum scores
            BASE_ITEMS.forEach(item => {
                const score = parseInt(formData.get(`q${item.id}`));
                
                // LPI: Cyclic 1-5 mapping
                const practiceKey = PRACTICE_KEYS_CYCLIC[(item.id - 1) % 5];
                lpi[practiceKey].sum += score;
                lpi[practiceKey].count++;

                // TMLH: Check explicit mapping
                Object.keys(TMLH_MAPPING).forEach(attrName => {
                    if (TMLH_MAPPING[attrName].includes(item.id)) {
                        tmlh[attrName].sum += score;
                    }
                });
            });

            return {
                lpi: Object.values(lpi).map(x => ({ ...x, pct: (x.sum / (x.count * 4)) * 100 })),
                tmlh: Object.values(tmlh).map(x => ({ ...x, pct: (x.sum / (x.count * 4)) * 100 }))
            };
        }

        function renderCharts(results) {
            if(lpiChartInstance) lpiChartInstance.destroy();
            if(tmlhChartInstance) tmlhChartInstance.destroy();
            
            // 1a. Bar Chart
            const barCtx = document.getElementById('lpiBarChart').getContext('2d');
            lpiChartInstance = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: results.lpi.map(x => x.name),
                    datasets: [{
                        data: results.lpi.map(x => x.pct),
                        backgroundColor: LPI_COLORS, // Use specific requested colors
                        borderRadius: 8
                    }]
                },
                options: { 
                    indexAxis: 'y', 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } }, 
                    scales: { x: { beginAtZero: true, max: 100 } },
                    animation: false 
                }
            });

            // 1b. LPI Table (Score + Descriptor)
            const lpiTableBody = document.getElementById('lpi-table-body');
            lpiTableBody.innerHTML = results.lpi.map(item => {
                const tier = getTier(item.pct);
                return `
                <tr>
                    <td class="py-4 font-bold text-slate-700">${item.name}</td>
                    <td class="py-4 text-center font-mono text-slate-500">${item.sum} / ${item.count * 4}</td>
                    <td class="py-4 text-right"><span class="px-3 py-1 rounded-full text-[10px] font-bold uppercase ${tier.class}">${item.pct.toFixed(0)}% - ${tier.label}</span></td>
                </tr>
            `}).join('');

            // 2b. TMLH Table (Score + Descriptor)
            const tmlhTableBody = document.getElementById('tmlh-table-body');
            tmlhTableBody.innerHTML = results.tmlh.map(attr => {
                const tier = getTier(attr.pct);
                return `<tr>
                    <td class="py-4 font-bold text-slate-700">${attr.name}</td>
                    <td class="py-4 text-center font-mono text-slate-500">${attr.sum} / ${attr.count * 4}</td>
                    <td class="py-4 text-right"><span class="px-3 py-1 rounded-full text-[10px] font-bold uppercase ${tier.class}">${attr.pct.toFixed(0)}% - ${tier.label}</span></td>
                </tr>`;
            }).join('');

            // 2a. Polar Area Chart
            const polarCtx = document.getElementById('tmlhPolarChart').getContext('2d');
            tmlhChartInstance = new Chart(polarCtx, {
                type: 'polarArea',
                data: { 
                    labels: results.tmlh.map(x => x.name), 
                    datasets: [{ 
                        data: results.tmlh.map(x => x.pct), 
                        backgroundColor: TMLH_COLORS, 
                        borderColor: '#fff', 
                        borderWidth: 2 
                    }] 
                },
                options: { 
                    maintainAspectRatio: false, 
                    animation: false, 
                    scales: { 
                        r: { 
                            min: 0, 
                            max: 100,
                            grid: { z: 0 },
                            ticks: { 
                                stepSize: 10,
                                display: true,
                                z: 5,
                                backdropColor: 'transparent',
                                color: 'rgba(100, 116, 139, 0.3)',
                                padding: 2,
                                font: { size: 10, weight: 'bold' }
                            } 
                        } 
                    }, 
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        // --- ROBUST PDF DOWNLOAD (MANUAL CONSTRUCTION) ---
        async function downloadReport() {
            const btn = document.getElementById('downloadPdfBtn');
            const originalText = btn.innerText;
            btn.innerText = "Processing PDF...";
            btn.disabled = true;

            const doc = new jspdf.jsPDF({
                orientation: 'p',
                unit: 'mm',
                format: 'a4'
            });

            // A4 dimensions
            const pageWidth = 210;
            const contentWidth = 190; // 10mm margin each side
            const margin = 10;

            // Helper to capture specific element by ID and add to PDF
            const captureAndAdd = async (elementId, yPos) => {
                const element = document.getElementById(elementId);
                const canvas = await html2canvas(element, { 
                    scale: 2, 
                    useCORS: true, 
                    logging: false 
                });
                const imgData = canvas.toDataURL('image/jpeg', 0.95);
                const imgHeight = (canvas.height * contentWidth) / canvas.width;
                doc.addImage(imgData, 'JPEG', margin, yPos, contentWidth, imgHeight);
            };

            try {
                // PAGE 1: Profile Header + AI Summary
                // Note: We capture the wrapper divs created for this purpose
                await captureAndAdd('pdf-page-1', margin);
                
                // PAGE 2: LPI Section
                doc.addPage();
                await captureAndAdd('pdf-page-2', margin);

                // PAGE 3: TMLH Section
                doc.addPage();
                await captureAndAdd('pdf-page-3', margin);

                // Save file
                doc.save(`Leadership_Report_${document.getElementById('display-name').innerText.trim().replace(/\s+/g, '_')}.pdf`);

            } catch (error) {
                console.error("PDF Error:", error);
                alert("Could not generate PDF. Please ensure content is visible.");
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        document.getElementById('assessmentForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            // Set header profile data
            document.getElementById('display-name').innerText = formData.get('userName');
            document.getElementById('display-class').innerText = 'Class: ' + formData.get('userClass');
            document.getElementById('display-cca').innerText = 'CCA: ' + formData.get('userCCA');

            lastResults = processScores(formData);
            renderCharts(lastResults);
            
            document.getElementById('form-section').classList.add('hidden');
            document.getElementById('main-header').classList.add('hidden');
            document.getElementById('results-area').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        document.getElementById('generateSummaryBtn').addEventListener('click', generateAISummary);
        document.getElementById('downloadPdfBtn').addEventListener('click', downloadReport);

        window.onload = renderQuestions;
    </script>
</body>
</html>